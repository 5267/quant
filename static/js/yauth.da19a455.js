define("achy/biz/yauth/modal",["lodash"],function(t){"use strict";!function(){function t(){var t=document.createElement("bootstrap"),e={WebkitTransition:"webkitTransitionEnd",MozTransition:"transitionend",OTransition:"oTransitionEnd otransitionend",transition:"transitionend"};for(var n in e)if(void 0!==t.style[n])return{end:e[n]};return!1}$.fn.emulateTransitionEnd=function(t){var e=!1,n=this;$(this).one("bsTransitionEnd",function(){e=!0});var i=function(){e||$(n).trigger($.support.transition.end)};return setTimeout(i,t),this},$(function(){$.support.transition=t(),$.support.transition&&($.event.special.bsTransitionEnd={bindType:$.support.transition.end,delegateType:$.support.transition.end,handle:function(t){return $(t.target).is(this)?t.handleObj.handler.apply(this,arguments):void 0}})})}();var e=function(t,e){this.options=e,this.$body=$(document.body),this.$element=$(t),this.$dialog=this.$element.find(".modal-dialog"),this.$backdrop=null,this.isShown=null,this.originalBodyPad=null,this.scrollbarWidth=0,this.ignoreBackdropClick=!1,this.options.remote&&this.$element.find(".modal-content").load(this.options.remote,$.proxy(function(){this.$element.trigger("loaded.bs.modal")},this))};e.VERSION="3.3.4",e.TRANSITION_DURATION=300,e.BACKDROP_TRANSITION_DURATION=150,e.DEFAULTS={backdrop:!0,keyboard:!0,show:!0},e.prototype.toggle=function(t){return this.isShown?this.hide():this.show(t)},e.prototype.show=function(t){var n=this,i=$.Event("show.bs.modal",{relatedTarget:t});this.$element.trigger(i),this.isShown||i.isDefaultPrevented()||(this.isShown=!0,this.checkScrollbar(),this.setScrollbar(),this.$body.addClass("modal-open"),this.escape(),this.resize(),this.$element.on("click.dismiss.bs.modal",'[data-dismiss="modal"]',$.proxy(this.hide,this)),this.$dialog.on("mousedown.dismiss.bs.modal",function(){n.$element.one("mouseup.dismiss.bs.modal",function(t){$(t.target).is(n.$element)&&(n.ignoreBackdropClick=!0)})}),this.backdrop(function(){var i=$.support.transition&&n.$element.hasClass("fade");n.$element.parent().length||n.$element.appendTo(n.$body),n.$element.show().scrollTop(0),n.adjustDialog(),i&&n.$element[0].offsetWidth,n.$element.addClass("in"),n.enforceFocus();var o=$.Event("shown.bs.modal",{relatedTarget:t});i?n.$dialog.one("bsTransitionEnd",function(){n.$element.trigger("focus").trigger(o)}).emulateTransitionEnd(e.TRANSITION_DURATION):n.$element.trigger("focus").trigger(o)}))},e.prototype.hide=function(t){t&&t.preventDefault(),t=$.Event("hide.bs.modal"),this.$element.trigger(t),this.isShown&&!t.isDefaultPrevented()&&(this.isShown=!1,this.escape(),this.resize(),$(document).off("focusin.bs.modal"),this.$element.removeClass("in").off("click.dismiss.bs.modal").off("mouseup.dismiss.bs.modal"),this.$dialog.off("mousedown.dismiss.bs.modal"),$.support.transition&&this.$element.hasClass("fade")?this.$element.one("bsTransitionEnd",$.proxy(this.hideModal,this)).emulateTransitionEnd(e.TRANSITION_DURATION):this.hideModal())},e.prototype.enforceFocus=function(){$(document).off("focusin.bs.modal").on("focusin.bs.modal",$.proxy(function(t){this.$element[0]===t.target||this.$element.has(t.target).length||this.$element.trigger("focus")},this))},e.prototype.escape=function(){this.isShown&&this.options.keyboard?this.$element.on("keydown.dismiss.bs.modal",$.proxy(function(t){27==t.which&&this.hide()},this)):this.isShown||this.$element.off("keydown.dismiss.bs.modal")},e.prototype.resize=function(){this.isShown?$(window).on("resize.bs.modal",$.proxy(this.handleUpdate,this)):$(window).off("resize.bs.modal")},e.prototype.hideModal=function(){var t=this;this.$element.hide(),this.backdrop(function(){t.$body.removeClass("modal-open"),t.resetAdjustments(),t.resetScrollbar(),t.$element.trigger("hidden.bs.modal")})},e.prototype.removeBackdrop=function(){this.$backdrop&&this.$backdrop.remove(),this.$backdrop=null},e.prototype.backdrop=function(t){var n=this,i=this.$element.hasClass("fade")?"fade":"";if(this.isShown&&this.options.backdrop){var o=$.support.transition&&i;if(this.$backdrop=$(document.createElement("div")).addClass("modal-backdrop "+i).appendTo(this.$body),this.$element.on("click.dismiss.bs.modal",$.proxy(function(t){return this.ignoreBackdropClick?void(this.ignoreBackdropClick=!1):void(t.target===t.currentTarget&&("static"==this.options.backdrop?this.$element[0].focus():this.hide()))},this)),o&&this.$backdrop[0].offsetWidth,this.$backdrop.addClass("in"),!t)return;o?this.$backdrop.one("bsTransitionEnd",t).emulateTransitionEnd(e.BACKDROP_TRANSITION_DURATION):t()}else if(!this.isShown&&this.$backdrop){this.$backdrop.removeClass("in");var s=function(){n.removeBackdrop(),t&&t()};$.support.transition&&this.$element.hasClass("fade")?this.$backdrop.one("bsTransitionEnd",s).emulateTransitionEnd(e.BACKDROP_TRANSITION_DURATION):s()}else t&&t()},e.prototype.handleUpdate=function(){this.adjustDialog()},e.prototype.adjustDialog=function(){var t=this.$element[0].scrollHeight>document.documentElement.clientHeight;this.$element.css({paddingLeft:!this.bodyIsOverflowing&&t?this.scrollbarWidth:"",paddingRight:this.bodyIsOverflowing&&!t?this.scrollbarWidth:""})},e.prototype.resetAdjustments=function(){this.$element.css({paddingLeft:"",paddingRight:""})},e.prototype.checkScrollbar=function(){var t=window.innerWidth;if(!t){var e=document.documentElement.getBoundingClientRect();t=e.right-Math.abs(e.left)}this.bodyIsOverflowing=document.body.clientWidth<t,this.scrollbarWidth=this.measureScrollbar()},e.prototype.setScrollbar=function(){var t=parseInt(this.$body.css("padding-right")||0,10);this.originalBodyPad=document.body.style.paddingRight||"",this.bodyIsOverflowing&&this.$body.css("padding-right",t+this.scrollbarWidth)},e.prototype.resetScrollbar=function(){this.$body.css("padding-right",this.originalBodyPad)},e.prototype.measureScrollbar=function(){var t=document.createElement("div");t.className="modal-scrollbar-measure",this.$body.append(t);var e=t.offsetWidth-t.clientWidth;return this.$body[0].removeChild(t),e};var n,i;return i={title:"",content:""},n=function(n){var o,s,a,r;a=this,n=t.extend({},i,e.DEFAULTS,n),s='<div class="modal fade"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">×</span><span class="sr-only">关闭</span></button><h4 class="modal-title"></h4></div><div class="modal-body"></div><div class="modal-footer"></div></div></div></div>',o=$(s),this.body=o.find(".modal-body"),this.title=o.find(".modal-title"),this.footer=o.find(".modal-footer"),n.content&&(r=t.isFunction(n.content)?n.content():n.content,this.body.append(r)),n.title&&this.title.html(n.title),$(document.body).append(o),this.$el=o,this.m=new e(this.$el,n),this.show()},n.prototype.show=function(){this.m.show()},n.prototype.hide=function(){this.m.hide()},n.prototype.destroy=function(){this.hide(),this.$el.remove()},n}),define("achy/biz/yauth/button",[],function(){"use strict";function t(t){return this.each(function(){var n=$(this),i=n.data("bs.button"),o="object"==typeof t&&t;i||n.data("bs.button",i=new e(this,o)),"toggle"==t?i.toggle():t&&i.setState(t)})}var e=function(t,n){this.$element=$(t),this.options=$.extend({},e.DEFAULTS,n),this.isLoading=!1};e.VERSION="3.3.4",e.DEFAULTS={loadingText:"loading..."},e.prototype.setState=function(t){var e="disabled",n=this.$element,i=n.is("input")?"val":"html",o=n.data();t+="Text",null==o.resetText&&n.data("resetText",n[i]()),setTimeout($.proxy(function(){n[i](null==o[t]?this.options[t]:o[t]),"loadingText"==t?(this.isLoading=!0,n.addClass(e).attr(e,e)):this.isLoading&&(this.isLoading=!1,n.removeClass(e).removeAttr(e))},this),0)},e.prototype.toggle=function(){var t=!0,e=this.$element.closest('[data-toggle="buttons"]');if(e.length){var n=this.$element.find("input");"radio"==n.prop("type")&&(n.prop("checked")&&this.$element.hasClass("active")?t=!1:e.find(".active").removeClass("active")),t&&n.prop("checked",!this.$element.hasClass("active")).trigger("change")}else this.$element.attr("aria-pressed",!this.$element.hasClass("active"));t&&this.$element.toggleClass("active")};var n=$.fn.button;return $.fn.button=t,$.fn.button.Constructor=e,$.fn.button.noConflict=function(){return $.fn.button=n,this},function(e){e.on("click.bs.button.data-api",'[data-toggle^="button"]',function(e){var n=$(e.target);n.hasClass("btn")||(n=n.closest(".btn")),t.call(n,"toggle"),e.preventDefault()}).on("focus.bs.button.data-api blur.bs.button.data-api",'[data-toggle^="button"]',function(t){$(t.target).closest(".btn").toggleClass("focus",/^focus(in)?$/.test(t.type))})}}),define("tpl!achy/biz/yauth/loginModal.tpl",[],function(){return function(obj){obj||(obj={});{var __t,__p="";_.escape}with(obj)__p+='<h3 class="login-title">登录</h3>\n<form class="form login-form">\n    <div class="form-group">\n        <label class="control-label" for="login-username">用户名</label>\n        <div class="input-group login-username">\n            <span class="input-group-addon">\n                <i class="fa fa-user" title="用户名"></i>\n            </span>\n            <input class="form-control" name="username" type="text" id="login-username" placeholder="用户名" tabindex="1">\n        </div>\n    </div>\n    <div class="form-group">\n        <label class="control-label" for="login-password">密码</label>\n        <div class="input-group login-password">\n            <span class="input-group-addon">\n                <i class="fa fa-lock" title="密码"></i>\n            </span>\n            <input class="form-control" name="password" type="password" id="login-password" placeholder="请输入密码" tabindex="2">\n        </div>\n    </div>\n    <div class="form-group captcha-group">\n        <label class="control-label" for="login-captcha">验证码</label>\n        <div class="input-group login-captcha">\n            <span class="input-group-addon">\n                <i class="fa fa-puzzle-piece" title="验证码"></i>\n            </span>\n            <input class="form-control" name="captcha" type="text" id="login-captcha" placeholder="请输入右边图片中的文字" tabindex="3">\n            <div class="captcha-img">\n                <img src="">\n                <i class="fa fa-refresh"></i>\n            </div>\n        </div>\n    </div>\n    <div class="error-msg"></div>\n    <button class="btn btn-primary btn-lg btn-block login-btn" data-loading-text="请稍候..." tabindex="3">立即登录</button>\n    <div class="links clearfix">\n        <a href="'+(null==(__t=appRoot)?"":__t)+'/cloud-portal/#/application/retrievePwd/" class="pull-right" target="_blank">忘记密码？</a>\n    </div>\n    <a class="btn btn-air-default btn-lg btn-block register-btn" href="'+(null==(__t=appRoot)?"":__t)+'/cloud-portal/#/application/start" target="_blank">免费注册</a>\n</form>\n';return __p}}),define("achy/biz/yauth/loginModal",["lodash","./modal","./button","tpl!./loginModal.tpl"],function(t,e,n,i){return function(t){t=t||{},t.appRoot=t.appRoot||"";var o=$.Deferred(),s=new e({title:"",content:i(t)}),a=function(){s.$el.find(".captcha-img img").attr("src",r())},r=function(){return window.getapi("usermaster","/captcha.json?"+Date.now())},l=s.$el.find(".form"),d=s.$el.find(".login-username input"),c=s.$el.find(".login-password input"),h=s.$el.find(".login-captcha input"),u=s.$el.find(".error-msg"),p=function(t){return t.val()?!1:!0},f=function(){l.addClass("need-captcha"),a()},m=function(){var t=d.val(),e=c.val(),n={username:t.split("@")[0],password:e};return t.split("@")[1]&&(n.tenant=t.split("@")[1]),l.hasClass("need-captcha")&&(n.captcha=h.val()),$.ajax({url:window.getapi("usermaster","/authenticate.json"),type:"POST",data:n})};return n(s.$el),s.$el.addClass("login-modal").find(".modal-header,.modal-footer").remove(),s.$el.on("hidden.bs.modal",function(){"pending"===o.state()&&o.reject(),s.destroy()}).on("click",".login-btn",function(t){t.preventDefault();var e=$(t.currentTarget);return p(d)||p(c)?void u.text("请填写用户名和密码"):l.hasClass("need-captcha")&&p(h)?void u.text("请填写验证码"):(e.button("loading"),void m().done(function(t){0===t.code&&("SUCCESS"===t.content.result?(s.hide(),o.resolve(t)):"CODE_REQUIRED"===t.content.result?f():"LOCKED"===t.content.result?u.text(-1!=t.content.principalName.search("@")?"您的企业账号由于多次密码验证错误已被锁定，请尝试找回密码或联系租户管理员":"您的个人账号由于多次密码验证错误已被锁定，请尝试找回密码"):"ERROR_CODE"===t.content.result?(u.text("验证码错误"),a()):(u.text("用户名或密码错误"),a()))}).always(function(){e.button("reset")}))}).on("keyup","input",function(t){return 13===t.keycode?void s.$el.find(".login-btn").trigger("click"):void(p(d)||p(c)||u.text(""))}).on("click",".captcha-img",function(){a()}),s.show(),o}}),define("tpl!achy/biz/yauth/defaultAvatar.tpl",[],function(){return function(obj){obj||(obj={});{var __p="";_.escape}with(obj)__p+="iVBORw0KGgoAAAANSUhEUgAAAGQAAABkCAIAAAD/gAIDAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyNpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuNS1jMDE0IDc5LjE1MTQ4MSwgMjAxMy8wMy8xMy0xMjowOToxNSAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENDIChNYWNpbnRvc2gpIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjdDNjQ1REEzNzE0MjExRTRCNzJERUMzQ0VDMEI0Mzk4IiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjdDNjQ1REE0NzE0MjExRTRCNzJERUMzQ0VDMEI0Mzk4Ij4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6N0M2NDVEQTE3MTQyMTFFNEI3MkRFQzNDRUMwQjQzOTgiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6N0M2NDVEQTI3MTQyMTFFNEI3MkRFQzNDRUMwQjQzOTgiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz5WpMyGAAADEklEQVR42uzc63KyMBAG4IrISRjv//a8BA4KeOo7ZtrP+WbqgFmyEN794XTaas3DJtnE0M3xePxiDIuABMQiFrGIRSxikYBYxCIWsYhFLBIQi1jEIpafEc7wPW1/4n6/933/eDyI9S82m00cx7vdLggCGL3+KEmSuq5vt9uqsaIoCsPQZBCM3mRZURRVVc3BSwELNHmeQ2r478OrbVvzNR4Bp9I9Q/c9Di3/r68N8cqy7PU7aZqWZYlBzefZEGPQWKmBfL5hIa2AJTjq4QW9xcJ8J9s8kSSdKdbwQX14Z/QWSzwRfO6G4m0jFrEWok8sdkONcIo1n82WNXZDx/rLxvJ5IS2eCI4zy9EWDWr3LMvElztxHMOr73uvMgtSWEVPsdjM8xxkXmFNuj0wxWXQxJq0wnK2UePD54bOal1HWEsvR51iTVoQOau2fMC6XC5eYU1XCuGVz+ezb1h1XcvmF16tfoZvFbzxQhRFIVUW+f8hq1SX6brOsZQC1vV6FRm/nI1TykVp0zSWR2JOp5P7tNLBQoFaVdXHrUWhYE7UrALLTGQYntElxz4RKely+pvL2hBeyK9R9aR5iuLKSXMhjWaPGrwgqzJUzWXXYVSa6EotDEt964KZtRysUft2a8+sUetEx0fX5oW13W5HYUVRtFIsc7p9bBqmaaqIpXOHRZIkaPYHHzTgWchHrbWhOyzQhGGI7EBvshl9omeY3TEsmFyqhVPr/N6gI/vpniEzUyTIsBIwj5Pe4iOPBRQ0AxkkfrLhr0uye8ZvLXZ5xhS7/pLtMQOwG6M380b8DKh1Xde2rWB1Fkq9xf1+7+zMwcC3hCuHmaRpGqksEygdkEqHw2FWUq+dNM9zqVuiAnsplEszP1mL/AKZMpa5zXQRZ5Ax52Cg0MRCei/otDZGfcvJJ7AZDuY5Tr330sHSLREcbHJIYjm+MVKqnrBZaQU2f/hrgWFzja3GLGJ5nlk63XChmaWDtdCwucafT/9lWa4Nmv8/i1jEIhaxiMUgFrGIRSxiEYtBLGIRi1jEIhaDWCPiW4ABAC2JLF1YyAJAAAAAAElFTkSuQmCC\n";return __p}}),define("achy/biz/yauth/main",["lodash","./loginModal","tpl!./defaultAvatar.tpl","css!./style.css"],function(t,e,n){var i=function(){this.user=null,this.tenant=null,this.anonymous=!0},o=i.prototype;return o.handle403=function(){var t=this;$.ajaxPrefilter(function(e,n,i){i.then(function(e){e&&-403===e.code&&t.forceLoginWithRedirect()})})},o.loginWithModal=function(t){var n=this,i=$.Deferred(),o=this.logined(t);return o.done(function(){i.resolve()}).fail(function(){n.closeLoginModal(),e(t).done(function(){n.logined().done(function(t){$("body").trigger("logined",[t]),i.resolve()}).fail(function(){i.reject()})}).fail(function(){i.reject()})}),i},o.forceLoginWithModal=function(e){return this.loginWithModal(t.defaults(e||{},{force:!0}))},o.loginWithWechat=function(t){var e=$.Deferred(),n=this.logined(t);return n.done(function(){e.resolve()}).fail(function(){var n=t.wechatParams;if(!n)return void e.reject();var i=n.code,o=n.state,s={username:i,password:o,identityType:"WECHAT_CORP"};$.ajax({url:window.getapi("usermaster","/authenticate.json"),type:"POST",data:s}).done(function(t){0===t.code&&("SUCCESS"===t.content.result?e.resolve(t):e.reject())})}),e},o.forceLoginWithWechat=function(){return this.loginWithWechat({force:!0})},o.loginWithRedirect=function(t){var e=$.Deferred(),n=this.logined(t);return t=t||{},n.done(function(){e.resolve()}).fail(function(){var e=t.redirectUrl||location.href,n=t.loginUrl||"/login.html?RelayState=";location.href=n+encodeURIComponent(e)}),e},o.forceLoginWithRedirect=function(e){return this.loginWithRedirect(t.defaults({force:!0},e||{}))},o.closeLoginModal=function(){var t=$(".login-modal");t[0]&&(t.on("hidden.bs.modal",function(){t.remove()}),t.modal("hide"))},o.logined=function(e){var n=this,i=$.Deferred();return e=t.defaults(e||{force:!1}),e.force||this.anonymous?($.ajax({url:window.getapi("cloud","/identity.json"),type:"GET",xhrFields:{withCredentials:!0}}).done(function(t){t.anonymous?(n.anonymous=t.anonymous,i.reject()):(n._updateProfile(t),i.resolve(t))}),i):(i.resolve(),i)},o.logout=function(t){$.ajax({url:window.getapi("usermaster","/logout.json"),type:"GET",xhrFields:{withCredentials:!0}}).done(function(){t&&(window.location.href=t)})},o.getAvatar=function(){var e=this,i=$.Deferred();return this.logined().done(function(){e.user.imageId?t.isNaN(parseInt(e.user.imageId))?e.user.imageId&&i.resolve(window.getfile(e.user.imageId)):$.ajax({url:window.getapi("cloud","/userCenter/getPic.json?imageId="+e.user.imageId),type:"GET",xhrFields:{withCredentials:!0}}).done(function(t){i.resolve("data:image/png;base64,"+t.data)}).fail(function(){i.reject()}):i.resolve("data:image/png;base64,"+n())}).fail(function(){i.reject()}),i},o._updateProfile=function(t){var e=t.user.name;t.user.surname&&t.user.givenName?e=t.user.surname+t.user.givenName:t.user.nickName&&(e=t.user.nickName),this.displayName=e,this.user=t.user,this.tenant=t.tenant,this.anonymous=t.anonymous},new i}),define("achy/biz/yauth",["achy/biz/yauth/main"],function(t){return t});